{{/*
Falco Values Override ConfigMap
This generates a values override file for the Falco subchart based on selected plugin type
*/}}
{{- if .Values.falco.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sib-k8s.fullname" . }}-falco-config
  labels:
    {{- include "sib-k8s.labels" . | nindent 4 }}
data:
  falco-values.yaml: |
    # Auto-generated Falco configuration for SIB-K8s
    # Plugin type: {{ .Values.auditPlugin.type }}
    
    controller:
      kind: {{ include "sib-k8s.falco.controllerKind" . }}
      {{- if eq (include "sib-k8s.falco.controllerKind" .) "deployment" }}
      deployment:
        replicas: 1
      {{- end }}
    
    # Driver configuration
    driver:
      {{- if .Values.syscallMonitoring.enabled }}
      enabled: true
      kind: {{ .Values.syscallMonitoring.driverKind }}
      {{- if eq .Values.syscallMonitoring.driverKind "modern_ebpf" }}
      modernEbpf:
        bufSizePreset: {{ .Values.syscallMonitoring.bufSizePreset }}
        dropFailedExit: {{ .Values.syscallMonitoring.dropFailedExit }}
      {{- else if eq .Values.syscallMonitoring.driverKind "ebpf" }}
      ebpf:
        bufSizePreset: {{ .Values.syscallMonitoring.bufSizePreset }}
        dropFailedExit: {{ .Values.syscallMonitoring.dropFailedExit }}
      {{- end }}
      {{- else }}
      enabled: false
      {{- end }}
    
    # Collectors configuration
    collectors:
      {{- if .Values.syscallMonitoring.enabled }}
      enabled: true
      containerEngine:
        enabled: true
      {{- else }}
      enabled: false
      {{- end }}
    
    # Falcoctl configuration
    falcoctl:
      artifact:
        install:
          enabled: true
        follow:
          enabled: true
      config:
        artifact:
          install:
            refs: {{ include "sib-k8s.falcoctl.installRefs" . }}
          follow:
            refs: {{ include "sib-k8s.falcoctl.followRefs" . }}
    
    {{- if eq .Values.auditPlugin.type "k8saudit" }}
    # Service for k8saudit webhook
    services:
      - name: k8saudit-webhook
        type: {{ .Values.auditPlugin.k8saudit.serviceType }}
        ports:
          - port: {{ .Values.auditPlugin.k8saudit.port }}
            {{- if eq .Values.auditPlugin.k8saudit.serviceType "NodePort" }}
            nodePort: {{ .Values.auditPlugin.k8saudit.nodePort }}
            {{- end }}
            protocol: TCP
    {{- end }}
    
    # Falco configuration
    falco:
      rules_files:
        {{- toYaml .Values.falco.falco.rules_files | nindent 8 }}
      
      # Load plugins
      load_plugins:
        - {{ include "sib-k8s.auditPlugin.name" . }}
        - json
        {{- if .Values.syscallMonitoring.enabled }}
        - container
        {{- end }}
      
      # Plugin configuration
      plugins:
        - name: {{ include "sib-k8s.auditPlugin.name" . }}
          library_path: {{ include "sib-k8s.auditPlugin.library" . }}
          init_config: {{ include "sib-k8s.auditPlugin.initConfig" . | quote }}
          open_params: {{ include "sib-k8s.auditPlugin.openParams" . | quote }}
        
        - name: json
          library_path: libjson.so
          init_config: ""
        
        {{- if .Values.syscallMonitoring.enabled }}
        - name: container
          library_path: /usr/share/falco/plugins/libcontainer.so
        {{- end }}
      
      priority: {{ .Values.falco.falco.priority }}
      json_output: {{ .Values.falco.falco.json_output }}
      json_include_output_property: {{ .Values.falco.falco.json_include_output_property }}
      json_include_tags_property: {{ .Values.falco.falco.json_include_tags_property }}
      
      # HTTP output to Falcosidekick
      http_output:
        enabled: {{ .Values.falcosidekick.enabled }}
        url: {{ include "sib-k8s.falcosidekick.url" . | quote }}
      
      {{- if .Values.falco.falco.metrics.enabled }}
      metrics:
        enabled: true
        interval: {{ .Values.falco.falco.metrics.interval }}
        output_rule: {{ .Values.falco.falco.metrics.outputRule }}
      {{- end }}
{{- end }}
