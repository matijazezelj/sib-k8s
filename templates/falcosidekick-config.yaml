{{/*
Falcosidekick Values Override ConfigMap
This generates a values override file for the Falcosidekick subchart
*/}}
{{- if .Values.falcosidekick.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "sib-k8s.fullname" . }}-sidekick-config
  labels:
    {{- include "sib-k8s.labels" . | nindent 4 }}
data:
  sidekick-values.yaml: |
    # Auto-generated Falcosidekick configuration for SIB-K8s
    
    replicaCount: {{ .Values.falcosidekick.replicaCount }}
    
    webui:
      enabled: {{ .Values.falcosidekick.webui.enabled }}
      replicaCount: {{ .Values.falcosidekick.webui.replicaCount }}
      redis:
        enabled: {{ .Values.falcosidekick.webui.redis.enabled }}
    
    config:
      debug: {{ .Values.falcosidekick.config.debug }}
      
      {{- if .Values.falcosidekick.config.customfields }}
      customfields: {{ .Values.falcosidekick.config.customfields | quote }}
      {{- end }}
      
      # Loki output
      {{- if .Values.loki.enabled }}
      loki:
        hostport: {{ include "sib-k8s.loki.url" . | quote }}
        {{- with .Values.falcosidekick.config.loki.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- else if .Values.falcosidekick.config.loki.hostport }}
      loki:
        hostport: {{ .Values.falcosidekick.config.loki.hostport | quote }}
        {{- with .Values.falcosidekick.config.loki.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # Webhook output (to analysis service)
      {{- if .Values.analysis.enabled }}
      webhook:
        address: "{{ include "sib-k8s.analysis.url" . }}/webhook"
        {{- with .Values.falcosidekick.config.webhook.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- else if .Values.falcosidekick.config.webhook.address }}
      webhook:
        address: {{ .Values.falcosidekick.config.webhook.address | quote }}
        {{- with .Values.falcosidekick.config.webhook.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # Slack output
      {{- if .Values.falcosidekick.config.slack.webhookurl }}
      slack:
        webhookurl: {{ .Values.falcosidekick.config.slack.webhookurl | quote }}
        {{- with .Values.falcosidekick.config.slack.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # Teams output
      {{- if .Values.falcosidekick.config.teams.webhookurl }}
      teams:
        webhookurl: {{ .Values.falcosidekick.config.teams.webhookurl | quote }}
        {{- with .Values.falcosidekick.config.teams.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # PagerDuty output
      {{- if .Values.falcosidekick.config.pagerduty.routingkey }}
      pagerduty:
        routingkey: {{ .Values.falcosidekick.config.pagerduty.routingkey | quote }}
        {{- with .Values.falcosidekick.config.pagerduty.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # AlertManager output
      {{- if .Values.falcosidekick.config.alertmanager.hostport }}
      alertmanager:
        hostport: {{ .Values.falcosidekick.config.alertmanager.hostport | quote }}
        {{- with .Values.falcosidekick.config.alertmanager.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
      
      # Elasticsearch output
      {{- if .Values.falcosidekick.config.elasticsearch.hostport }}
      elasticsearch:
        hostport: {{ .Values.falcosidekick.config.elasticsearch.hostport | quote }}
        index: {{ .Values.falcosidekick.config.elasticsearch.index | quote }}
        {{- with .Values.falcosidekick.config.elasticsearch.minimumpriority }}
        minimumpriority: {{ . | quote }}
        {{- end }}
      {{- end }}
{{- end }}
