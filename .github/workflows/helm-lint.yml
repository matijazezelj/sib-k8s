name: Helm Lint and Test

on:
  push:
    branches:
      - main
    paths:
      - 'Chart.yaml'
      - 'values*.yaml'
      - 'templates/**'
      - 'rules/**'
      - '.github/workflows/helm-lint.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'Chart.yaml'
      - 'values*.yaml'
      - 'templates/**'
      - 'rules/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repos
        run: |
          helm repo add falcosecurity https://falcosecurity.github.io/charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Build dependencies
        run: helm dependency build --skip-refresh

      - name: Helm lint
        run: helm lint .

      - name: Helm template (default)
        run: helm template sib-k8s . --debug

      - name: Helm template (EKS)
        run: helm template sib-k8s . -f values-eks.yaml --debug

      - name: Helm template (GKE)
        run: helm template sib-k8s . -f values-gke.yaml --debug

      - name: Helm template (AKS)
        run: helm template sib-k8s . -f values-aks.yaml --debug

  chart-testing:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repos
        run: |
          helm repo add falcosecurity https://falcosecurity.github.io/charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Build dependencies
        run: helm dependency build --skip-refresh

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Run chart-testing (lint)
        run: ct lint --target-branch ${{ github.event.repository.default_branch }} --charts . --validate-maintainers=false
